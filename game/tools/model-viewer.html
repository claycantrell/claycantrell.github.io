<!DOCTYPE html>
<html>
<head>
    <title>Model Viewer</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a2e; }
        canvas { display: block; }
        #controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: #0f0;
            font-family: monospace;
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            max-height: 90vh;
            overflow-y: auto;
        }
        #controls select, #controls button {
            background: #333;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px 10px;
            margin: 5px 0;
            cursor: pointer;
            font-family: monospace;
            width: 100%;
        }
        #controls button:hover { background: #0f0; color: #000; }
        #controls optgroup { color: #0a0; }
        #info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            color: #666;
            font-family: monospace;
            font-size: 12px;
        }
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #0f0;
            font-family: monospace;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div id="loading">Loading game scripts...</div>
    <div id="controls" style="display:none;">
        <b>MODEL VIEWER</b><br><br>
        <select id="modelSelect">
            <optgroup label="Characters">
                <option value="knight">Knight</option>
                <option value="test">Test Character</option>
            </optgroup>
            <optgroup label="Animals">
                <option value="cow">Cow</option>
                <option value="deer">Deer</option>
                <option value="bunny">Bunny</option>
                <option value="bird">Bird</option>
            </optgroup>
            <optgroup label="Trees - Conifer">
                <option value="tree-pine">Pine</option>
                <option value="tree-spruce">Spruce</option>
                <option value="tree-snowyPine">Snowy Pine</option>
                <option value="tree-deadwood">Deadwood</option>
            </optgroup>
            <optgroup label="Trees - Deciduous">
                <option value="tree-oak">Oak</option>
                <option value="tree-birch">Birch</option>
                <option value="tree-acacia">Acacia</option>
                <option value="tree-jungleTree">Jungle Tree</option>
                <option value="tree-palm">Palm</option>
            </optgroup>
            <optgroup label="Shrubs - Desert">
                <option value="shrub-cactus">Cactus</option>
                <option value="shrub-desertBush">Desert Bush</option>
                <option value="shrub-deadBush">Dead Bush</option>
            </optgroup>
            <optgroup label="Shrubs - Rocks">
                <option value="shrub-boulder">Boulder</option>
                <option value="shrub-rock">Rock</option>
                <option value="shrub-smallRock">Small Rock</option>
            </optgroup>
            <optgroup label="Shrubs - Grass">
                <option value="shrub-grassClump">Grass Clump</option>
                <option value="shrub-tallGrass">Tall Grass</option>
                <option value="shrub-beachGrass">Beach Grass</option>
            </optgroup>
            <optgroup label="Shrubs - Plants">
                <option value="shrub-fern">Fern</option>
                <option value="shrub-bush">Bush</option>
                <option value="shrub-berryBush">Berry Bush</option>
                <option value="shrub-tropicalPlant">Tropical Plant</option>
                <option value="shrub-wildflower">Wildflower</option>
            </optgroup>
            <optgroup label="Shrubs - Cold/Moss">
                <option value="shrub-moss">Moss</option>
                <option value="shrub-lichen">Lichen</option>
                <option value="shrub-alpineShrub">Alpine Shrub</option>
                <option value="shrub-lowPine">Low Pine</option>
            </optgroup>
        </select>
        <br>
        <button onclick="loadModel()">Load Model</button>
        <button onclick="toggleWireframe()">Wireframe</button>
        <button onclick="toggleRotate()">Auto-Rotate</button>
        <br><br>
        <small>Drag: Orbit | Scroll: Zoom | Right-drag: Pan</small>
    </div>
    <div id="info">Three.js Model Viewer - Using actual game models</div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Make THREE global so game scripts can use it
        window.THREE = THREE;

        // ============================================
        // STUB FUNCTIONS FOR GAME SCRIPTS
        // ============================================

        // Terrain height - just return 0 in viewer
        window.getTerrainHeight = () => 0;
        window.getTerrainHeightAt = () => 0;
        window.calculateTerrainHeight = () => ({ height: 0, climate: null, biome: null });

        // Shadow enabling
        window.enableShadows = (group) => {
            group.traverse(child => {
                if (child.isMesh) {
                    child.castShadow = true;
                    child.receiveShadow = true;
                }
            });
        };

        // Scene adding - no-op, we add manually
        window.addToScene = () => {};

        // Entity object creation - just return the group
        window.createEntityObject = (id, group, x, y, z, extras) => {
            return { id, group, ...extras };
        };

        // Entity list getter - return empty array
        window.getEntityList = () => [];

        // Entity system creation - no-op
        window.createEntitySystem = () => ({});

        // Config getter - return minimal config
        window.getConfigSafe = (type) => ({
            heightOffset: 0.4,
            collisionRadius: 1
        });

        // Export globals - no-op
        window.exportEntityGlobals = () => {};

        // GAME namespace stub
        window.GAME = {
            scene: null,
            characterParts: null,
            characterType: 'knight',
            world: { objects: [] }
        };

        // Systems registry stub
        window.Systems = {
            register: () => {}
        };

        // Performance config stub (needed by trees.js)
        window.PERFORMANCE = {
            treeCount: 800,
            treeDetail: 'high',
            rendering: {
                lodEnabled: true,
                lodDistance: 100
            }
        };

        // Shared materials stub (needed by trees.js)
        window.sharedMaterials = { trunk: null };
        window.initSharedMaterials = () => {};
        window.treeData = [];

        // Character stub
        window.character = { position: new THREE.Vector3(0, 0, 0) };

        // ============================================
        // SCENE SETUP
        // ============================================
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);
        window.GAME.scene = scene;
        window.scene = scene; // trees.js and shrubs.js use global scene

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(5, 3, 5);
        window.camera = camera; // For shrub billboard updates

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Lighting
        const ambient = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambient);

        const directional = new THREE.DirectionalLight(0xffffff, 1);
        directional.position.set(5, 10, 5);
        directional.castShadow = true;
        scene.add(directional);

        // Ground plane
        const groundGeo = new THREE.PlaneGeometry(40, 40);
        const groundMat = new THREE.MeshStandardMaterial({ color: 0x333344 });
        const ground = new THREE.Mesh(groundGeo, groundMat);
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // Grid helper
        const grid = new THREE.GridHelper(40, 40, 0x444466, 0x333355);
        scene.add(grid);

        let currentModel = null;
        let wireframeMode = false;

        // ============================================
        // LOAD ACTUAL GAME SCRIPTS
        // ============================================
        const gameScripts = [
            '../engine/utils/character-types.js',
            '../systems/entities/deer.js',
            '../systems/entities/cow.js',
            '../systems/entities/bunny.js',
            '../systems/entities/bird.js',
            '../systems/trees.js',
            '../systems/shrubs.js'
        ];

        async function loadGameScripts() {
            for (const src of gameScripts) {
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = resolve;
                    script.onerror = () => {
                        console.warn(`Failed to load ${src}, continuing...`);
                        resolve();
                    };
                    document.body.appendChild(script);
                });
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('controls').style.display = 'block';

            loadModel();
        }

        // ============================================
        // MODEL LOADING
        // ============================================
        window.loadModel = function() {
            if (currentModel) {
                scene.remove(currentModel);
                currentModel.traverse(child => {
                    if (child.geometry) child.geometry.dispose();
                    if (child.material) {
                        if (Array.isArray(child.material)) {
                            child.material.forEach(m => m.dispose());
                        } else {
                            child.material.dispose();
                        }
                    }
                });
            }

            const type = document.getElementById('modelSelect').value;
            let model = null;

            // Characters
            if (type === 'knight') {
                if (typeof createKnightCharacter === 'function') {
                    model = createKnightCharacter();
                }
            } else if (type === 'test') {
                if (typeof createTestCharacter === 'function') {
                    model = createTestCharacter();
                }
            }
            // Animals
            else if (type === 'cow') {
                if (typeof createCow === 'function') {
                    const result = createCow('viewer-cow', 0, 0);
                    model = result.group || result;
                }
            } else if (type === 'deer') {
                if (typeof createDeer === 'function') {
                    const result = createDeer('viewer-deer', 0, 0);
                    model = result.group || result;
                }
            } else if (type === 'bunny') {
                if (typeof createBunny === 'function') {
                    const result = createBunny('viewer-bunny', 0, 0);
                    model = result.group || result;
                }
            } else if (type === 'bird') {
                if (typeof createBird === 'function') {
                    const result = createBird('viewer-bird', 0, 0);
                    model = result.group || result;
                }
            }
            // Trees
            else if (type.startsWith('tree-')) {
                const treeVariant = type.replace('tree-', '');
                if (typeof create3DTree === 'function') {
                    model = create3DTree(0, 0, 'high', treeVariant);
                }
            }
            // Shrubs
            else if (type.startsWith('shrub-')) {
                const shrubName = type.replace('shrub-', '');
                if (typeof createShrubSprite === 'function') {
                    // Create a fake shrub type object
                    const shrubTypes = {
                        cactus: { name: 'cactus', color: 0x2d5a27, height: 3, width: 1.5 },
                        desertBush: { name: 'desertBush', color: 0x8b7355, height: 1.5, width: 2 },
                        deadBush: { name: 'deadBush', color: 0x6b4423, height: 1, width: 1.5 },
                        boulder: { name: 'boulder', color: 0x606060, height: 4, width: 5 },
                        rock: { name: 'rock', color: 0x707070, height: 2, width: 3 },
                        smallRock: { name: 'smallRock', color: 0x808080, height: 1, width: 1.5 },
                        grassClump: { name: 'grassClump', color: 0x7cba3d, height: 1.2, width: 1.5 },
                        tallGrass: { name: 'tallGrass', color: 0x6b8e23, height: 1.5, width: 1 },
                        beachGrass: { name: 'beachGrass', color: 0xbdb76b, height: 1, width: 1.2 },
                        fern: { name: 'fern', color: 0x228b22, height: 1.5, width: 2 },
                        bush: { name: 'bush', color: 0x556b2f, height: 1.8, width: 2.2 },
                        berryBush: { name: 'berryBush', color: 0x2e8b57, height: 2, width: 2.5 },
                        tropicalPlant: { name: 'tropicalPlant', color: 0x32cd32, height: 2.5, width: 2 },
                        wildflower: { name: 'wildflower', color: 0x7DB37D, height: 0.8, width: 1 },
                        moss: { name: 'moss', color: 0x556b2f, height: 0.4, width: 1.5 },
                        lichen: { name: 'lichen', color: 0x708090, height: 0.3, width: 1.5 },
                        alpineShrub: { name: 'alpineShrub', color: 0x556b2f, height: 1.2, width: 1.8 },
                        lowPine: { name: 'lowPine', color: 0x2f4f4f, height: 1.5, width: 2 }
                    };
                    const shrubType = shrubTypes[shrubName] || shrubTypes.bush;
                    model = createShrubSprite(0, 0, shrubType, 0);
                }
            }

            if (model) {
                // Reset position for viewer
                model.position.set(0, 0, 0);

                // Enable shadows
                model.traverse(child => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });

                currentModel = model;
                scene.add(currentModel);

                // Auto-adjust camera target and distance based on model size
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);

                controls.target.copy(center);

                // Adjust camera distance based on model size
                const distance = maxDim * 2;
                camera.position.set(distance, distance * 0.6, distance);
                controls.update();
            } else {
                console.error(`Failed to create model: ${type}`);
            }
        };

        window.toggleWireframe = function() {
            wireframeMode = !wireframeMode;
            if (currentModel) {
                currentModel.traverse(child => {
                    if (child.material) {
                        if (Array.isArray(child.material)) {
                            child.material.forEach(m => m.wireframe = wireframeMode);
                        } else {
                            child.material.wireframe = wireframeMode;
                        }
                    }
                });
            }
        };

        window.toggleRotate = function() {
            controls.autoRotate = !controls.autoRotate;
        };

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // Handle resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Start
        animate();
        loadGameScripts();
    </script>
</body>
</html>
